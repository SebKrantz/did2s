---
output: github_document
bibliography: references.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# did2s

<!-- badges: start -->
<!-- badges: end -->

The goal of did2s is to estimate TWFE models without running into the problem of staggered treatment adoption. 

## Installation

You can install did2s from github with:

``` r
devtools::install_github("kylebutts/did2s")
```

## Two-stage Difference-in-differences [@Gardner_2021]


For details on the methodology, view this [vignette](http://kylebutts.com/did2s/articles/Two-Stage-Difference-in-Differences.html)

I have created an R package with the help of John Gardner to estimate the two-stage difference-in-differences estimator. To install the package, run the following:

```{r, eval = FALSE}
devtools::install_github("kylebutts/did2s")
```

To view the documentation, type `?did2s` into the console.


The main function is `did2s` which estimates the two-stage did procedure. This function requires the following options:

- `yname`: the outcome variable
- `first_stage_formula`: formula for first stage, can include fixed effects and covariates, but do not include treatment variable(s)!
- `treat_formula`: This should be the treatment variable or in the case of event studies, treatment variables.
- `treat_var`: This has to be the 0/1 treatment variable that marks when treatment turns on for a unit. If you suspect anticipation, see note above for accounting for this.
- `cluster_var`: Which variables to cluster on
- `weights`: Optional variable to run a weighted first- and second-stage regressions
- `bootstrap`: Should standard errors be bootstrapped instead? Default is False.
- `n_bootstraps`: How many clustered bootstraps to perform for standard errors. Default is 250.

did2s returns a list with two objects:

1. fixest estimate for the second stage with corrected standard errors.

### TWFE vs. Two-Stage DID Example

I will load example data from the package and plot the average outcome among the groups. Here is one unit's data:

```{r load-data, code_folding=TRUE,}

library(tidyverse)
library(did2s)
library(fixest)
library(rmarkdown)

# Load theme
source("https://raw.githubusercontent.com/kylebutts/templates/master/ggplot_theme/theme_kyle.R")

# Load Data from R package
data("df_het")

# One observation
df_het %>% select(unit, g, year, treat, rel_year, dep_var) %>% head(n = 31) %>% pander::pander()
```

Here is a plot of the average outcome variable for each of the groups:

```{r plot-df-het, fig.width=8, fig.height=4, fig.cap="Example data with heterogeneous treatment effects", code_folding=TRUE, layout="l-body-outset"}
# Plot Data 
df_avg <- df_het %>% 
  group_by(group, year) %>% 
  summarize(dep_var = mean(dep_var), .groups = 'drop')

# Get treatment years for plotting
gs <- df_het %>% 
  filter(treat == TRUE) %>% 
  pull(g) %>% unique()
	
	
ggplot() + 
	geom_line(data = df_avg, mapping = aes(y = dep_var, x = year, color = group), size = 1.5) +
	geom_vline(xintercept = gs - 0.5, linetype = "dashed") + 
	theme_kyle(base_size = 16) +
	theme(legend.position = "bottom") +
	labs(y = "Outcome", x = "Year", color = "Treatment Cohort") + 
	scale_y_continuous(expand = expansion(add = .5)) + 
	scale_color_manual(values = c("Group 1" = "#d2382c", "Group 2" = "#497eb3", "Group 3" = "#8e549f")) 
```


### Estimate Two-stage Difference-in-Differences 

First, lets estimate a static did:

```{r static}

# Static
static <- did2s(df_het, 
				yname = "dep_var", first_stage_formula = ~i(state) + i(year), 
				treat_formula = ~i(treat, ref=FALSE), treat_var = "treat", 
				cluster_var = "state")

fixest::esttable(static)

```

This is very close to the true treatment effect of `r df_het %>% filter(treat == 1) %>% summarize(att = mean(te + te_dynamic)) %>% pull(att)`.

Then, let's estimate an event study did:

```{r event-study}

# Event Study
es <- did2s(df_het,
			yname = "dep_var", first_stage_formula = ~i(state) + i(year), 
			treat_formula = ~i(rel_year, ref=c(-1, Inf)), treat_var = "treat", 
			cluster_var = "state")

fixest::esttable(es)

```

And plot the results:

```{r plot-es, fig.width=8, fig.height=4, fig.cap="Event-study plot with example data", code_folding=TRUE, layout="l-body-outset"}

pts <- broom::tidy(es) %>%
    filter(str_detect(term, "rel_year::")) %>%
	select(rel_year = term, estimate, se = std.error) %>%
    mutate(
        rel_year = as.numeric(str_remove(rel_year, "rel_year::")) + 0.05,
        ci_lower = estimate - 1.96 * se,
        ci_upper = estimate + 1.96 * se,
        group = "Estimated Effect"
    ) %>%
    filter(rel_year <= 8 & rel_year >= -8)

te_true <- df_het %>%
    # Keep only treated units
    filter(g > 0) %>%
    group_by(rel_year) %>%
    summarize(estimate = mean(te + te_dynamic)) %>%
	mutate(group = "True Effect") %>%
    filter(rel_year >= -8 & rel_year <= 8) %>%
	mutate(rel_year = rel_year - 0.05)

pts <- bind_rows(pts, te_true)

max_y <- max(pts$estimate)

ggplot() +
    # 0 effect
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_vline(xintercept = -0.5, linetype = "dashed") +
    # Confidence Intervals
    geom_linerange(data = pts, mapping = aes(x = rel_year, ymin = ci_lower, ymax = ci_upper), color = "grey30") +
    # Estimates
    geom_point(data = pts, mapping = aes(x = rel_year, y = estimate, color = group), size = 2) +
    # Label
    geom_label(data = data.frame(x = -0.5 - 0.1, y = max_y + 0.25, label = "Treatment Starts â–¶"), label.size=NA,
               mapping = aes(x = x, y = y, label = label), size = 5.5, hjust = 1, fontface = 2, inherit.aes = FALSE) +
    scale_x_continuous(breaks = -8:8, minor_breaks = NULL) +
    scale_y_continuous(minor_breaks = NULL) +
    scale_color_manual(values = c("Estimated Effect" = "#013ef5", "True Effect" = "#eb3f25")) +
    labs(x = "Relative Time", y = "Estimate", color = NULL, title = NULL) +
    theme_kyle(base_size = 16) +
    theme(legend.position = "bottom")

```






## References



